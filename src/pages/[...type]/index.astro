---
import { collections } from '@/content.config';
import BaseLayout from '@/layouts/BaseLayout.astro';
import Hero from '@/components/common/Hero.astro';
import { camelToTitle } from '@/utils';
import { getContentItems, groupByCategory } from '@/utils/content-utils';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
	const availTypes = Object.keys(collections);
	// TODO: simplify / make cleaner
	const allThings = (
		await Promise.all(availTypes.map((t) => getCollection(t as any)))
	).map((v, i) => [availTypes[i], v]);
	const paths = allThings.map((resultArr: any[]) => {
		const type = resultArr[0];
		const things = resultArr[1];
		return {
			params: { type },
			props: { things },
		};
	});
	return paths.flat();
}

const { type } = Astro.params;
const typeTitle = type[0].toUpperCase() + type.substring(1);
const items = await getContentItems(type);
const grouped = groupByCategory(items);
---

<BaseLayout pageTitle={camelToTitle(typeTitle)}>

	<!-- TODO: use Hero slot for tags filter -->
	<Hero
		title={camelToTitle(typeTitle)}
		subtitle={`Browse all ${typeTitle.toLowerCase()}`}
		size="is-small"
	/>

	<section class="section">
		<div class="container">
			<div class="categories-masonry">
				{
					Array.from(grouped.entries()).map(([category, items]) => (
						<div class="category-block">
							<div class="category-header">
								<h2 class="title is-4 has-text-primary mb-0">
									{category
										.replace(/-/g, ' ')
										.replace(/\b\w/g, (l) => l.toUpperCase())}
								</h2>
								<span class="tag is-light is-rounded is-small ml-2 is-unselectable">
									{items.length}
								</span>
							</div>

							<ul class="compact-list">
								{items.map((item) => (
									<li class="list-item">
										{item.hasPage ? (
											<a href={`/${type}/${item.slug}`} class="item-link">
												<span class="item-title">{item.title}</span>
												{item.note && <span class="item-note"> — {item.note}</span>}
											</a>
										) : (
											<span class="item-wrapper">
												<span class="item-title">{item.title}</span>
												{item.note && <span class="item-note"> — {item.note}</span>}
											</span>
										)}
									</li>
								))}
							</ul>
						</div>
					))
				}
			</div>
		</div>
	</section>
</BaseLayout>

<style is:global>
	.categories-masonry {
		display: block;
		width: 100%;
		margin: 0 auto;
		column-count: 1;
		column-gap: 2rem;
		column-fill: balance;
	}

	@media (min-width: 768px) {
		.categories-masonry {
			column-count: 2;
		}
	}

	@media (min-width: 1024px) {
		.categories-masonry {
			column-count: 3;
		}
	}

	.category-block {
		break-inside: avoid;
		margin-bottom: 2rem;
		display: block;
	}

	.category-header {
		display: flex;
		align-items: center;
		margin-bottom: 1rem;
		padding-bottom: 0.5rem;
		border-bottom: 2px solid #f5f5f5;
	}

	.compact-list {
		list-style: none;
		padding: 0;
		margin: 0;
	}

	.list-item {
		margin-bottom: 0.5rem;
		font-size: 0.95rem;
		line-height: 1.4;
	}

	.item-link {
		text-decoration: underline;
		text-underline-offset: 0.2rem;
		color: #2c3e50;
		transition: color 0.1s;
	}

	.item-link:hover {
		color: hsl(171, 100%, 41%);
	}

	.item-title {
		font-weight: 500;
	}

	.item-note,
	.item-wrapper {
		color: #666;
	}

	.item-note {
		font-size: 0.9em;
		font-style: italic;
		opacity: 0.8;
	}
</style>
