---
import { collections } from '@/content.config';
import BaseLayout from '@/layouts/BaseLayout.astro';
import Hero from '@/components/common/Hero.astro';
import { camelToTitle } from '@/utils';
import { getContentItems, groupByCategory } from '@/utils/content-utils';

export async function getStaticPaths() {
	const availTypes = Object.keys(collections);
	const paths = [];

	for (const type of availTypes) {
		const items = await getContentItems(type as any);

		// Add root collection path
		paths.push({ params: { type } });

		// Add folder paths
		const parents = new Set(items.map(i => i.parent).filter(Boolean));
		for (const parent of parents) {
			paths.push({ params: { type: `${type}/${parent}` } });
		}
	}

	return paths;
}

const { type } = Astro.params;

// Parse type to get collection and potential parent folder
const parts = type.split('/');
const collectionName = parts[0];
const parentFolder = parts.length > 1 ? parts.slice(1).join('/') : undefined;

const collectionTitle = camelToTitle(collectionName);
const pageTitle = parentFolder
	? `${collectionTitle} / ${parentFolder.split('/').map(camelToTitle).join(' / ')}`
	: collectionTitle;

// Get items and filter by parent if needed
let items = await getContentItems(collectionName as any);
if (parentFolder) {
	// Filter for items in this specific folder (acting as parent)
	items = items.filter(item => item.parent === parentFolder);
}

const grouped = groupByCategory(items);

import { getAllThoughts } from "@/utils/content-utils";
import ThoughtsFeed from "@/components/common/ThoughtsFeed.astro";

// Fetch thoughts for this collection (and potentially parent folder)
// The getAllThoughts function supports filtering by "type" or "type/parent"
// We can use the 'type' param directly from Astro.params which includes the full slug path e.g. "tools/ai"
const thoughts = await getAllThoughts(type);
---

<BaseLayout pageTitle={pageTitle}>

	<!-- TODO: use Hero slot for tags filter -->
	<Hero
		title={pageTitle}
		subtitle={`Browse all ${collectionName}`}
		size="is-small"
	/>

	{thoughts.length > 0 && (
			<section class="section" style="padding-top: 1rem; padding-bottom: 2rem;">
					<div class="container">
							<h3 class="title is-5 mb-3">Latest Thinks</h3>
							<ThoughtsFeed thoughts={thoughts} limit={10} />
					</div>
			</section>
	)}

	<section>
		<div class="container">
			<div class="categories-masonry">
				{
					Array.from(grouped.entries()).map(([category, items]) => (
						<div class="category-block">
							<div class="category-header">
								<h2 class="title is-4 has-text-primary mb-0">
									{category
										.replace(/-/g, ' ')
										.replace(/\b\w/g, (l) => l.toUpperCase())}
								</h2>
								<span class="tag is-light is-rounded is-small ml-2 is-unselectable">
									{items.length}
								</span>
							</div>

							<ul class="compact-list">
								{items.map((item) => (
									<li class="list-item">
										{item.hasPage ? (
											<a href={`/${collectionName}/${item.slug}`} class="item-link">
												<span class="item-title">{item.title}</span>
												{item.note && <span class="item-note"> — {item.note}</span>}
											</a>
										) : (
											<span class="item-wrapper">
												<span class="item-title">{item.title}</span>
												{item.note && <span class="item-note"> — {item.note}</span>}
											</span>
										)}
									</li>
								))}
							</ul>
						</div>
					))
				}
			</div>
		</div>
	</section>
</BaseLayout>

<style is:global>
	.categories-masonry {
		display: block;
		width: 100%;
		margin: 0 auto;
		column-count: 1;
		column-gap: 2rem;
		column-fill: balance;
	}

	@media (min-width: 768px) {
		.categories-masonry {
			column-count: 2;
		}
	}

	@media (min-width: 1024px) {
		.categories-masonry {
			column-count: 3;
		}
	}

	.category-block {
		break-inside: avoid;
		margin-bottom: 2rem;
		display: block;
	}

	.category-header {
		display: flex;
		align-items: center;
		margin-bottom: 1rem;
		padding-bottom: 0.5rem;
		border-bottom: 2px solid #f5f5f5;
	}

	.compact-list {
		list-style: none;
		padding: 0;
		margin: 0;
	}

	.list-item {
		margin-bottom: 0.5rem;
		font-size: 0.95rem;
		line-height: 1.4;
	}

	.item-link {
		text-decoration: underline;
		text-underline-offset: 0.2rem;
		color: #2c3e50;
		transition: color 0.1s;
	}

	.item-link:hover {
		color: hsl(171, 100%, 41%);
	}

	.item-title {
		font-weight: 500;
	}

	.item-note,
	.item-wrapper {
		color: #666;
	}

	.item-note {
		font-size: 0.9em;
		font-style: italic;
		opacity: 0.8;
	}
</style>
