---
import { getCollection } from 'astro:content';
import { render } from 'astro:content';
import BaseLayout from '@/layouts/BaseLayout.astro';
import { collections } from '@/content.config';
import ThingRef from '@/components/common/ThingRef.astro';
import ThoughtsList from '@/components/common/ThoughtsList.astro';
import ThoughtsFeed from '@/components/common/ThoughtsFeed.astro';
import { updateThoughts } from '@/utils/content-utils';

export async function getStaticPaths() {
	const availTypes = Object.keys(collections);
	const things = (
		await Promise.all(availTypes.map((t) => getCollection(t as any)))
	).map((v, i) => [availTypes[i], v]);
	const paths = things.map((resultArr: any[]) => {
		const type = resultArr[0];
		const collection = resultArr[1];
		return collection.map((thing: any) => ({
			params: { slug: thing.id.replace(/\.mdx$/, ''), type },
			props: { thing },
		}));
	});
	return paths.flat();
}

const { thing } = Astro.props;
const { Content } = await render(thing);
const { type } = Astro.params;
let subtype = '';
if (thing.id.includes('/')) {
    const parts = thing.id.split('/');
    subtype = parts[0];
}

function formatDate(timestamp?: number): string {
	if (!timestamp) return '';
	const date = new Date(timestamp * 1000);
	return date.toLocaleDateString('en-US', {
		year: 'numeric',
		month: 'long',
		day: 'numeric',
	});
}

const thoughts = updateThoughts(thing.data.thoughts, thing);

const hasSidebarContent = thing.data.url || (thing.data.references && thing.data.references.length > 0);

// TODO: support mdx pages having layout option overrides
//   e.g. noSidebar, noThoughts, similar, etc.
---

<BaseLayout pageTitle={thing.data.title} pageDescription={thing.data.summary}>
	<!-- This page is a general view for any Thing that doesn't already have a specific page for it. -->
	<section class="section">
		<div class="container">
            <header class="thing-header">
                {subtype && (
                    <p class="breadcrumb-label">
                        <a href={`/${type}`}>{type}</a>
                        {subtype && (
                            <>
                                <span class="breadcrumb-separator">/</span>
                                <a href={`/${type}/${subtype}`}>{subtype}</a>
                            </>
                        )}
                    </p>
                )}

                <h2 class="title is-2">{thing.data.title}</h2>
                <!-- TODO maybe: display other Things with the same (or fuzzy?) name ("See also"?) -->

                {thing.data.summary && (
                    <p class="subtitle is-4 has-text-grey-dark">{thing.data.summary}</p>
                )}

                <!-- Tags -->
                {thing.data.tags && thing.data.tags.length > 0 && (
                    <div class="sidebar-block">
                        <div class="tags-list">
                            {thing.data.tags.map((tag: string) => (
                                <span class="tag is-light">{tag}</span>
                            ))}
                        </div>
                    </div>
                )}

                <div class="metadata-bar">
                    {thing.data.created && (
                        <span class="metadata-item">
                            <strong>Posted:</strong> {formatDate(thing.data.created)}
                        </span>
                    )}
                    {thing.data.updated && (
                        <span class="metadata-item">
                            <strong>Updated:</strong> {formatDate(thing.data.updated)}
                        </span>
                    )}

                </div>
            </header>

			<div class:list={["content-layout", { "has-sidebar": hasSidebarContent }]}>
				<!-- Main Content Column -->
                <div class="main-column">
                    {thing.data.thoughts && thing.data.thoughts.length > 0 && (
                        <section style="padding-bottom: 2rem;">
                            <div class="container">
                                <h3 class="title is-5 mb-3">Latest Thinks</h3>
                                <ThoughtsFeed thoughts={thoughts as any} limit={10} />
                            </div>
                        </section>
                    )}

                    <!-- MDX Content -->
                    <div class="mdx-content content">
                        <Content />
                    </div>

                    {thing.data.notes && (
                        <div class="notes-section">
                            <h3 class="title is-4">Notes</h3>
                            <div class="notes-content">
                                <p>{thing.data.notes}</p>
                            </div>
                        </div>
                    )}
                </div>

                <!-- Sidebar Column -->
                {hasSidebarContent && (
                    <aside class="sidebar-column">
                        {thing.data.url && (
                            <div class="sidebar-block">
                                <a href={thing.data.url} target="_blank" rel="noopener noreferrer" class="button is-primary is-outlined is-fullwidth">
                                    Go to {thing.data.title} â†’
                                </a>
                            </div>
                        )}

                        <!-- References -->
                        {thing.data.references && thing.data.references.length > 0 && (
                            <div class="sidebar-block">
                                <h4 class="sidebar-title">References</h4>
                                <ul class="references-list">
                                    {thing.data.references.map((ref: any) => (
                                        <li class="reference-item">
                                            <ThingRef ref={ref} />
                                        </li>
                                    ))}
                                </ul>
                            </div>
                        )}
                    </aside>
                )}
			</div>
		</div>
	</section>
</BaseLayout>

<!-- TODO: client-side (floating?) table of contents, when content scrolls + has headings -->

<style is:global>
	pre {
		text-wrap: auto;
	}
</style>

<style>
    .section {
        padding: 1.5rem;
    }

	.thing-header {
		margin-bottom: 1rem;
		padding-bottom: 0.5rem;
		border-bottom: 1px solid #eee;

	}
    .thing-header p {
        cursor: default;
    }

    .breadcrumb-label {
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-weight: 600;
        margin-bottom: 0.75rem;
        color: #999;
    }

    .breadcrumb-label a {
        color: #666;
        text-decoration: underline;
        text-underline-offset: 0.15rem;
        transition: color 0.2s ease;
    }

    .breadcrumb-label a:hover {
        color: #333;
        text-decoration: underline;
    }

    .breadcrumb-separator {
        margin: 0 0.25rem;
        opacity: 0.5;
    }

    .metadata-bar {
        display: flex;
        gap: 1.5rem;
        margin-top: 0.5rem;
        font-size: 0.9rem;
        color: #777;
    }

    .content-layout {
        display: grid;
        grid-template-columns: 1fr;
        gap: 3rem;
    }

    .content-layout.has-sidebar {
        grid-template-columns: 1fr 300px;
    }

    .main-column {
        min-width: 0; /* Prevents flex/grid overflow issues */
    }

    .sidebar-column {
        display: flex;
        flex-direction: column;
        gap: 2rem;
    }

    .sidebar-block {
        margin-bottom: 1rem;
    }

    .sidebar-title {
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: #999;
        font-weight: 700;
        margin-bottom: 0.75rem;
    }

    .mdx-content {
        line-height: 1.7;
        font-size: 1.05rem;
    }

	.notes-section {
		margin-top: 3rem;
		padding: 1.5rem;
		background: #fafafa;
		border-radius: 8px;
        border: 1px solid #f0f0f0;
	}

	.references-list {
		list-style: none;
		padding: 0;
        margin: 0;
	}

	.reference-item {
        padding: 0.5rem 0;
		border-bottom: 1px solid #f5f5f5;
        font-size: 0.9rem;
	}

    .tags-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

	@media screen and (max-width: 768px) {
		.content-layout {
            grid-template-columns: 1fr;
            gap: 2rem;
        }

        .sidebar-column {
            order: 2; /* Sidebar below content on mobile, or maybe above? */
            /* Creating a visual separation */
            border-top: 1px solid #eee;
            padding-top: 2rem;
        }
	}
</style>
